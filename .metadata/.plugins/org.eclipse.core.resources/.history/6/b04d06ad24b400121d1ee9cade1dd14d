package com.comp4903.project.graphics.tile;

import java.io.IOException;
import java.io.InputStream;

import org.xmlpull.v1.XmlPullParser;
import org.xmlpull.v1.XmlPullParserException;

import android.content.Context;
import android.content.res.AssetManager;
import android.util.Xml;

public class TileSetDefinition {
	
	String name;
	String fileName;
	
	String texFileName;
	int textureMap;
	
	int numberOfTiles;
	Tile[] tiles = new Tile[100];
	
	String ns = "def";
	
	public TileSetDefinition(String f, Context c)
	{
		fileName = f;
		AssetManager am = c.getAssets();
		
		numberOfTiles = 0;
		
		try {
			InputStream buf = null;
			buf = am.open(fileName);
			XMLparseTileSet(buf);
			buf.close();
			
		} catch (IOException e)
		{ }			
	}
	
	public void XMLparseTileSet(InputStream buf) throws IOException
	{
		try
		{
			XmlPullParser parser = Xml.newPullParser();
			parser.setFeature(XmlPullParser.FEATURE_PROCESS_NAMESPACES, true);
            parser.setInput(buf, null);
            parser.nextTag();
            String nmsp = parser.getNamespace();
            processXML(parser);
			
		} catch (XmlPullParserException e)
		{}		
		finally {
			
		}
	}
	
	public void processXML(XmlPullParser parser) throws XmlPullParserException, IOException
	{
		parser.require(XmlPullParser.START_TAG, ns, "tileset");
		
		while (parser.next() != XmlPullParser.END_TAG)
		{
			if (parser.getEventType() != XmlPullParser.START_TAG)
				continue;
			
			String name = parser.getName();
			
			if (name.equals("tileset"))
				processTileSetTag(parser);
			
			if (name.equals("tile"))
				processTileTag(parser);
		}
	}
	
	public void processTileSetTag(XmlPullParser parser) throws XmlPullParserException, IOException
	{		
		name = parser.getAttributeValue(ns, "name");
		texFileName = parser.getAttributeValue(ns, "map");
	}
	
	public void processTileTag(XmlPullParser parser) throws XmlPullParserException, IOException
	{
		tiles[numberOfTiles] = new Tile(parser.getAttributeValue(ns, "name"));
		while (parser.next() != XmlPullParser.END_TAG)
		{
			if (parser.getEventType() != XmlPullParser.START_TAG)
				continue;
			
			String name = parser.getName();
			
			if (name.equals("base"))
				processBaseTag(parser);			
			
		}
		
	}
	
	public void processBaseTag(XmlPullParser parser) throws XmlPullParserException, IOException
	{
		while (parser.next() != XmlPullParser.END_TAG)
		{
			if (parser.getEventType() != XmlPullParser.START_TAG)
				continue;
			
			String name = parser.getName();
			
			if (name.equals("point1"))
				readUV(parser, 0);	
			
			if (name.equals("point2"))
				readUV(parser, 1);	
			
			if (name.equals("point3"))
				readUV(parser, 2);	
			
			if (name.equals("point4"))
				readUV(parser, 3);	
			
			if (name.equals("point5"))
				readUV(parser, 4);
			
			if (name.equals("point6"))
				readUV(parser, 5);	
		}
	}
	
	public void readUV(XmlPullParser parser, int p) throws XmlPullParserException, IOException
	{
		tiles[numberOfTiles].texcoords[p * 2] = Float.parseFloat(parser.getAttributeValue(ns, "u"));
		tiles[numberOfTiles].texcoords[p * 2 + 1] = Float.parseFloat(parser.getAttributeValue(ns, "v"));
	}
}
